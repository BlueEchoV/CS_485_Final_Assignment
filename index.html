<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="styles.css">
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

<script src="js/sprite.js"></script>
<script src="js/spider.js"></script>
<script src="js/boid.js"></script>
<script src="js/projectile.js"></script>
<script src="js/boss.js"></script>
<script src="js/ant.js"></script>


</head>
<body style="">
<canvas id='mycanvas' style="" onmousemove="coordinate(event)">
</canvas>


<script>
	var test_Bool = false;

    const canvas = document.querySelector("canvas");
    const sprites_to_draw = new Array(2); 
    var draw_loop_timeout;
    var img = new Image();
    var firefly_Img = new Image();
    /*
    const up_arrow = 38;
    const down_arrow = 40;
    const left_arrow = 37;
    const right_arrow = 39;
    */
    const up_arrow = 87;
    const down_arrow = 83;
    const left_arrow = 65;
    const right_arrow = 68;
    const space_bar = 32;

    var level = 1;
    var start = new Date();

    var mouse_x;
    var mouse_y;

    //const penguin_states = ["idle","idleBackAndForth","idleBreathing","idleFall","idleLayDown","idleLookAround","idleLookDown","idleLookLeft",
    //"idleLookRight","idleLookUp","idleSit","idleSpin","idleWave","walk_E","walk_N","walk_NE","walk_NW","walk_S","walk_SE","walk_SW","walk_W"];
    const player_states = ["idle","walk_E","walk_W"];
    const firefly_states = ["idle"];
    const spider_states = ["walk_E","walk_W"];
    const boss_states = ["walk_E","walk_W"];
    const rock_states = ["move"];
    const ant_states = ["walk_E","walk_W"];

    const background_images = ["bk_1","bk_2","bk_3"];
    

    var key_change = false;
    var key_num = [];

    var key_press = { 'UP' : null,
                    'RIGHT' : null,
                    'LEFT' : null,
                    'DOWN' : null,
                    'SPACE_BAR' : null
                                }

    //for spacebar
    var pressed = false;

    //
    var rock_data = null;
    var boss_data = null;
    var spider_data = null;
    var firefly_data = null;
    var player_data = null;
    
    sprites_to_draw[0] = new Array(0); //background and 
    sprites_to_draw[1] = new Array(0); //forground

	load_Jsons(); 

	async function load_Jsons() {
		//Preload Boss
		$.getJSON( "assets/enemy_boss_imgs/animationData.json", function( data ) {
				
				for(var i = 0;i< boss_states.length;i++){
					for(var j = 0; j < data["boss"][boss_states[i]].length; j++){
						console.log("loading spider data");
						data["boss"][boss_states[i]][j]['img'] = new Image();
						data["boss"][boss_states[i]][j]['img'].src = 'assets/enemy_boss_imgs/' + boss_states[i] + '/' + j + '.png';
					}
				}
            sprites_to_draw[1].push( new Boss(data, "walk_E") );
            boss_data = data;
		});

		//Preload Spider
		$.getJSON( "assets/enemy_spider_imgs/animationData.json", function( data ) {
				
					for(var i = 0;i< spider_states.length;i++){
						for(var j = 0; j < data["spider"][spider_states[i]].length; j++){
							console.log("loading spider data");
							data["spider"][spider_states[i]][j]['img'] = new Image();
							data["spider"][spider_states[i]][j]['img'].src = 'assets/enemy_spider_imgs/' + spider_states[i] + '/' + j + '.png';
						}
					}
            spider_data = data;
			//sprites_to_draw[1].push( new spider(data, "walk_E") );
		});

		//Preload Player
		$.getJSON( "assets/player_imgs/animationData.json", function( data ) {
				
					for(var i = 0;i< player_states.length;i++){
						for(var j = 0; j < data["player"][player_states[i]].length; j++){
							console.log("loading player data");
							data["player"][player_states[i]][j]['img'] = new Image();
							data["player"][player_states[i]][j]['img'].src = 'assets/player_imgs/' + player_states[i] + '/' + j + '.png';
						}
					}
			sprites_to_draw[1].push( new Sprite(data, 150 ,600, "idle") );
		});

		//Preload firefly
		$.getJSON( "assets/firefly_imgs/animationData.json", function( data ) {
			for(var i = 0;i< firefly_states.length;i++){
						for(var j = 0; j < data["firefly"][firefly_states[i]].length; j++){
							console.log("loading firefly data");
							data["firefly"][firefly_states[i]][j]['img'] = new Image();
							data["firefly"][firefly_states[i]][j]['img'].src = 'assets/firefly_imgs/' + firefly_states[i] + '/' + j + '.png';
						}
			}
			
            firefly_data = data;
			
		});

        //Preload ant
		$.getJSON( "assets/enemy_ant_imgs/animationData.json", function( data ) {
			for(var i = 0;i< ant_states.length;i++){
						for(var j = 0; j < data["ant"][ant_states[i]].length; j++){
							console.log("loading ant data");
							data["ant"][ant_states[i]][j]['img'] = new Image();
							data["ant"][ant_states[i]][j]['img'].src = 'assets/enemy_ant_imgs/' + ant_states[i] + '/' + j + '.png';
						}
			}
			
            ant_data = data;
			
		});

		//Preload rock
		$.getJSON( "assets/rock_imgs/animationData.json", function( data ) {
			for(var i = 0;i< rock_states.length;i++){
						for(var j = 0; j < data["rock"][rock_states[i]].length; j++){
							console.log("loading rock data");
							data["rock"][rock_states[i]][j]['img'] = new Image();
							data["rock"][rock_states[i]][j]['img'].src = 'assets/rock_imgs/' + rock_states[i] + '/' + j + '.png';
						}
			}
			rock_data = data;
		});
	}

    $( document ).ready(function() {
        
        console.log( "Page is now ready" );
        resize();
        img.onload = function() {
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };
        img.src = 'assets/bkg_imgs/bk_1.jpg';
        //img.src = 'assets/bkg_imgs/bk_1.jpg';

        setTimeout(() => {
            requestAnimationFrame(draw_loop);
        }, "1000");
    });

    window.addEventListener('resize', resize);

    function draw_loop(){
        var background_length = sprites_to_draw[0].length;
        var forground_length  = sprites_to_draw[1].length;
        var has_background_changed = false;
        
        //Draw background sprites
        for(var i = 0; i < background_length; i++){
            has_background_changed = sprites_to_draw[0][i].draw();
        }

        document.body.onkeydown = function(e){
            
            if(e.keyCode == up_arrow){
                key_change = true;
                key_press["UP"] = e.keyCode;
            } 
            if(e.keyCode == right_arrow){
                //alert(String.fromCharCode(e.keyCode)+" --> "+e.keyCode);
                key_change = true;
                key_press["RIGHT"] = e.keyCode;
            }
            if(e.keyCode == left_arrow){
                key_change = true;
                key_press["LEFT"] = e.keyCode;
            }
            if(e.keyCode == down_arrow){
                key_change = true;
                key_press["DOWN"] = e.keyCode;
            }
            if(e.keyCode == space_bar){
                e.preventDefault()
                if(!pressed)
                    key_press["SPACE_BAR"] = e.keyCode;
                pressed = true;
            }
            
        
        };
        document.body.onkeyup = function(e){
            //alert(e.keyCode);
            
            if(key_press["UP"] == e.keyCode){
                key_press["UP"] = null;
            }
            if(key_press["RIGHT"] == e.keyCode){
                key_press["RIGHT"] = null;
            }
            if(key_press["LEFT"] == e.keyCode){
                key_press["LEFT"] = null;
            }
            if(key_press["DOWN"] == e.keyCode){
                key_press["DOWN"] = null;
            }

            if(e.keyCode == space_bar){
                key_press["SPACE_BAR"] = null;
                pressed = false;
            }

            if(key_press["UP"] == null && key_press["RIGHT"] == null && key_press["LEFT"] == null && key_press["DOWN"] == null){
                key_change = false;
            }
            
        };
		
        var ctx = canvas.getContext('2d');
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		// ctx.globalCompositeOperation = 'destination-over';
		ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
       
	   //Draw forground sprites
        for(var sprite of sprites_to_draw[1]){
			if (test_Bool === false) {
				console.log("Drawing: ", sprite);
			}
            if (typeof sprite.flock === "function") { 
                sprite.edges(canvas.width,canvas.height);
                sprite.draw({ 'foreground_sprites' : sprites_to_draw[1]
                                        });
                sprite.flock(sprites_to_draw[1]);
            } else {
				// This is a dictionary that is passed
				// This is so these values are accessable inside the .js class
				// Key / Value pair 
                sprite.draw( { 'has_background_changed' : has_background_changed,
                                          'key_change' : key_change,
                                          'key_press' : key_press,
                                          'foreground_sprites' : sprites_to_draw[1],
                                          'mouse_coords' : {'x' : mouse_x, 'y' : mouse_y},
                                          'rock_data' : rock_data
                                        }
            );
                if(sprite.constructor.name == "Sprite"){
                    level_logic(sprite);
                }
            }
        }
        test_Bool = true;
        requestAnimationFrame(draw_loop);
    }

    

    function resize(){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        /*
        try{
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }catch(err){
        }*/
    }

    function coordinate(event) {
        mouse_x = event.clientX;
        mouse_y = event.clientY;
    }

    var spawn = true;
    var firefly_count = 10;
    var level_up = true;
    var frequency = 5;
    var spider_scale = 1;
    var spider_speed = 1;
    function level_logic(sprite){
            
            

            var elapsed = new Date() - start;


            //On level up, once at start of level
            if(level_up == true){
                console.log("level:" + level);
                random_background(); //change background

                firefly_count *= 1.1;//increase firefly count by 10% each level
                spider_speed *= 1.1; //increase speed of spider by 10% each level
                spider_scale = Math.ceil(level/3); //quantity of spiders spawning per wave
                frequency = 5; //seconds between spawning spiders

                //spawn fireflies
                for(let i=0;i<firefly_count;i++){
                    sprites_to_draw[1].push( new Boid(firefly_data, "idle") );
                }

                //spawn ants
                for(let i=0;i<firefly_count;i++){
                    sprites_to_draw[1].push( new Ant(ant_data, "walk_E") );
                }

                //do this only once per level up
                level_up = false;
            }

            //spider spawning logic
            if(Math.floor(elapsed/1000) % frequency == 0){
                if(spawn){
                    for(let i=0;i<spider_scale;i++){
                        sprites_to_draw[1].push( new spider(spider_data, "walk_E", spider_speed) );
                    }
                    
                }
                spawn = false;
            } else {
                spawn = true;
            }

            //Check if it's time to level up
            if(sprite.points >= firefly_count){
                sprite.points = 0;
                level_up = true;
                level +=1;
            }
                
    }

    function random_background(){
        const random = Math.ceil(Math.random() * background_images.length);


        img.src = 'assets/bkg_imgs/bk_' + random + '.jpg';
    }
</script>

</body>
</html>

